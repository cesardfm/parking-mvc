<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  th:replace="~{layout/dashboard :: layout(
          pageTitle='Nueva Reserva', 
          activeMenu='tickets',
          contentTemplate=~{::content})}"
>
  <head>
    <!-- Esta secci√≥n ser√° reemplazada por el layout -->
  </head>
  <body>
    <!-- Fragment de contenido -->
    <div th:fragment="content">
      <div class="max-w-3xl mx-auto">
        <!-- Header Section -->
        <div class="mb-8">
          <div class="flex items-center gap-4 mb-4">
            <a
              th:href="@{/tickets/{parkingId}(parkingId=${parking.id})}"
              class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <svg
                class="w-6 h-6 text-gray-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </a>
            <div>
              <h1 class="text-2xl font-bold text-gray-900">
                Crear Nuevo Tiquete
              </h1>
              <p class="text-gray-600 mt-1">
                Ingresa la informaci√≥n b√°sica de la reserva
              </p>
            </div>
          </div>
        </div>

        <!-- Form Card -->
        <div
          class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
        >
          <form th:action="@{/tickets/crear}" method="post" class="p-8">
            <!-- Error Alert -->
            <div th:if="${error}" class="mb-6">
              <div
                th:replace="~{fragments/cards :: alert(type='error', message=${error})}"
              ></div>
            </div>

            <!-- Success Alert -->
            <div th:if="${mensaje}" class="mb-6">
              <div
                th:replace="~{fragments/cards :: alert(type='success', message=${mensaje})}"
              ></div>
            </div>

            <!-- Form Fields -->
            <div class="space-y-6">
              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-gray-50 rounded-xl border border-gray-200"
              >
                <div>
                  <label
                    for="licensePlate"
                    class="block text-sm font-semibold text-gray-700 mb-2"
                  >
                    Placa *
                  </label>
                  <input type="file" id="image" name="image" accept="image/*" />
                  <img id="preview" width="200" />
                  <input
                    type="text"
                    id="licensePlate"
                    name="licensePlate"
                    required
                    placeholder="Ej: AFQ523"
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-primary-100 focus:border-primary-500 transition-all text-gray-900 placeholder-gray-400"
                  />
                </div>

                <div>
                  <label
                    for="color"
                    class="block text-sm font-semibold text-gray-700 mb-2"
                  >
                    Color *
                  </label>
                  <input
                    type="text"
                    id="color"
                    name="color"
                    required
                    placeholder="Ej: Azul, rojo, amarillo"
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-primary-100 focus:border-primary-500 transition-all text-gray-900 placeholder-gray-400"
                  />
                </div>

                <div>
                  <label
                    for="categoryId"
                    class="block text-sm font-semibold text-gray-700 mb-2"
                  >
                    Categor√≠a *
                  </label>
                  <select
                    id="categoryId"
                    name="categoryId"
                    required
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-primary-100 focus:border-primary-500 transition-all text-gray-900"
                  >
                    <option value="">Seleccionar una categor√≠a</option>
                    <option
                      th:each="category: ${categories}"
                      th:value="${category.id}"
                      th:text="${category.name}"
                    ></option>
                  </select>
                </div>
              </div>

              <div>
                <label
                  for="entryTime"
                  class="block text-sm font-semibold text-gray-700 mb-2"
                >
                  Hora de Entrada
                </label>
                <input
                  type="datetime-local"
                  id="entryTime"
                  name="entryTime"
                  readonly
                  th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd''T''HH:mm')}"
                  class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-xl text-gray-700 cursor-not-allowed opacity-75"
                />
                <p class="mt-2 text-xs text-gray-500">
                  Se ingresa autom√°ticamente.
                </p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Parqueadero
                </label>
                <input
                  type="hidden"
                  id="parkingId"
                  name="parkingId"
                  th:value="${parking.id}"
                />
                <input
                  type="text"
                  readonly
                  th:value="${parking.name}"
                  class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-xl text-gray-700 cursor-not-allowed opacity-75"
                />
              </div>

              <!-- Secci√≥n de Niveles -->
              <div
                class="bg-white rounded-2xl shadow-sm border border-gray-200"
              >
                <div class="px-6 py-5 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <div>
                      <h2 class="text-xl font-bold text-gray-900">
                        Selecciona un Nivel
                      </h2>
                      <p class="text-sm text-gray-500 mt-1">
                        Total:
                        <span
                          class="font-semibold"
                          th:text="${#lists.size(levels)}"
                          >0</span
                        >
                        niveles disponibles
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Select de Niveles -->
                <div class="px-6 py-5">
                  <select
                    id="levelSelect"
                    name="levelId"
                    required
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-primary-100 focus:border-primary-500 transition-all text-gray-900"
                  >
                    <option value="">Seleccionar un nivel</option>
                    <option
                      th:each="level : ${levels}"
                      th:value="${level.id}"
                      th:text="${'Nivel ' + level.id + ' (' + (level.rows * level.columns) + ' espacios)'}"
                    ></option>
                  </select>
                </div>
              </div>

              <!-- Grilla de Espacios (Sites) -->
              <div
                id="sitesContainer"
                class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-6"
              >
                <h2 class="text-lg font-bold text-gray-900 mb-4">
                  Selecciona un Sitio
                </h2>
                <div id="sitesGrid" class="grid gap-2 mb-4"></div>

                <!-- Informaci√≥n del sitio seleccionado -->
                <div
                  id="selectedSiteInfo"
                  class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg"
                >
                  <p class="text-sm font-medium text-green-900">
                    ‚úì Sitio seleccionado:
                    <span id="selectedSiteNumber" class="font-bold"></span>
                  </p>
                </div>

                <input
                  type="hidden"
                  id="siteId"
                  name="siteId"
                  value=""
                  required
                />
              </div>
            </div>

            <!-- Form Actions -->
            <div
              class="flex items-center gap-3 mt-8 pt-6 border-t border-gray-200"
            >
              <button
                type="submit"
                class="flex-1 sm:flex-initial bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-semibold px-8 py-3 rounded-xl transition-all transform hover:scale-105 shadow-md flex items-center justify-center gap-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <span>Generar Tiquete</span>
              </button>

              <a
                href="/tickets/listarParkings"
                class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-xl transition-colors"
              >
                Cancelar
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- DATOS OCULTOS PARA JAVASCRIPT -->
      <div style="display: none" id="sitesDataContainer">
        <div
          th:each="level : ${levels}"
          th:attr="data-level-id=${level.id},
                  data-rows=${level.rows},
                  data-columns=${level.columns},
                  data-sites=${@siteDataJson.toJson(level.sites)}"
          data-level-sites
        ></div>
      </div>

      <!-- SCRIPT INLINE COMPLETO -->
      <script th:inline="javascript">
        document
          .getElementById("image")
          .addEventListener("change", function (event) {
            const file = event.target.files[0];
            document.getElementById("preview").src = URL.createObjectURL(file);
          });
        /*<![CDATA[*/
        console.log("=== SCRIPT INICIADO ===");

        // Primero, verificar que los datos existen en el HTML
        (function () {
          const elements = document.querySelectorAll("[data-level-sites]");
          console.log("Elementos encontrados:", elements.length);

          elements.forEach((el, idx) => {
            console.log("Elemento", idx, ":", {
              levelId: el.getAttribute("data-level-id"),
              rows: el.getAttribute("data-rows"),
              columns: el.getAttribute("data-columns"),
              sitesLength: el.getAttribute("data-sites")?.length,
            });
          });
        })();

        // Variables globales
        let selectedSite = null;
        const sitesData = {};

        // Cargar datos
        function loadSitesData() {
          const elements = document.querySelectorAll("[data-level-sites]");

          elements.forEach((el) => {
            const levelId = el.getAttribute("data-level-id");
            const sitesJson = el.getAttribute("data-sites");
            const rows = parseInt(el.getAttribute("data-rows"));
            const columns = parseInt(el.getAttribute("data-columns"));

            try {
              const sites = JSON.parse(sitesJson);
              sitesData[levelId] = { sites, rows, columns };
              console.log(`Nivel ${levelId} cargado:`, sites.length, "sitios");
            } catch (e) {
              console.error(`Error en nivel ${levelId}:`, e);
            }
          });
        }

        // Renderizar grilla
        function renderGrid(sites, rows, columns) {
          console.log(
            "Renderizando grilla:",
            rows,
            "x",
            columns,
            "=",
            sites.length,
            "sitios"
          );

          const grid = document.getElementById("sitesGrid");
          grid.style.gridTemplateColumns = `repeat(${columns}, minmax(60px, 80px))`;
          grid.className = "grid gap-3 mb-4 justify-center";

          // Crear mapa de sitios
          const sitesMap = {};
          sites.forEach((site) => {
            const key = `${site.posY}-${site.posX}`;
            sitesMap[key] = site;
            console.log(
              "Sitio mapeado:",
              key,
              "-> ID:",
              site.id,
              "Status:",
              site.status
            );
          });

          // Detectar si las posiciones empiezan desde 0 o desde 1
          const startsFromOne = sites.some((s) => s.posX === 1 || s.posY === 1);
          const startRow = startsFromOne ? 1 : 0;
          const startCol = startsFromOne ? 1 : 0;

          console.log(
            "üî¢ Posiciones empiezan desde:",
            startsFromOne ? "1" : "0"
          );

          let html = "";
          let availableCount = 0;

          for (let row = 0; row < rows; row++) {
            for (let col = 0; col < columns; col++) {
              // Ajustar √≠ndices seg√∫n si empiezan desde 0 o 1
              const actualRow = row + startRow;
              const actualCol = col + startCol;
              const key = `${actualRow}-${actualCol}`;
              const site = sitesMap[key];

              if (site) {
                const isAvailable = site.status === "available";
                if (isAvailable) availableCount++;

                const bgColor = isAvailable
                  ? "bg-green-500 border-green-600 hover:bg-green-600"
                  : "bg-gray-400 border-gray-500";

                html += `
                  <div 
                    class="${bgColor} aspect-square rounded-lg border-2 flex flex-col items-center justify-center transition-all ${
                  isAvailable
                    ? "cursor-pointer hover:scale-105"
                    : "cursor-not-allowed"
                } select-none"
                    ${
                      isAvailable
                        ? `onclick="selectSite(${site.id}, '${actualRow}-${actualCol}')"`
                        : ""
                    }
                    data-site-id="${site.id}"
                    data-status="${site.status}"
                  >
                    <span class="text-white text-sm font-bold">${actualRow}-${actualCol}</span>
                    ${
                      !isAvailable
                        ? '<span class="text-white text-[10px] opacity-80">Ocupado</span>'
                        : ""
                    }
                  </div>
                `;
              } else {
                console.warn("‚ö†Ô∏è No se encontr√≥ sitio en posici√≥n:", key);
              }
            }
          }

          grid.innerHTML = html;
          console.log(
            "‚úÖ Grilla renderizada con",
            availableCount,
            "sitios disponibles de",
            sites.length,
            "totales"
          );
        }

        // Seleccionar sitio
        function selectSite(siteId, siteNumber) {
          console.log(
            "‚úÖ Sitio seleccionado:",
            siteId,
            "Posici√≥n:",
            siteNumber
          );

          // Remover selecci√≥n previa
          document.querySelectorAll("[data-site-id]").forEach((el) => {
            el.classList.remove("ring-4", "ring-blue-500", "scale-110");
          });

          // Seleccionar nuevo sitio
          const siteEl = document.querySelector(`[data-site-id="${siteId}"]`);
          if (siteEl) {
            siteEl.classList.add("ring-4", "ring-blue-500", "scale-110");
          }

          // Actualizar input hidden
          document.getElementById("siteId").value = siteId;
          console.log("Input siteId actualizado a:", siteId);

          // Mostrar confirmaci√≥n
          document.getElementById("selectedSiteNumber").textContent =
            siteNumber;
          document
            .getElementById("selectedSiteInfo")
            .classList.remove("hidden");

          // Scroll suave
          document.getElementById("selectedSiteInfo").scrollIntoView({
            behavior: "smooth",
            block: "nearest",
          });
        }

        // Manejar cambio de nivel
        function handleLevelChange(e) {
          const levelId = e.target.value;
          console.log("üîÑ Nivel seleccionado:", levelId);

          const container = document.getElementById("sitesContainer");
          const siteIdInput = document.getElementById("siteId");
          const selectedInfo = document.getElementById("selectedSiteInfo");

          // Limpiar selecci√≥n previa
          siteIdInput.value = "";
          selectedInfo.classList.add("hidden");

          if (!levelId) {
            console.log("‚ö†Ô∏è No hay nivel seleccionado, ocultando contenedor");
            container.classList.add("hidden");
            return;
          }

          const data = sitesData[levelId];
          console.log("üìä Datos del nivel:", data);

          if (data) {
            console.log("‚úÖ Renderizando grilla para nivel", levelId);
            renderGrid(data.sites, data.rows, data.columns);
            container.classList.remove("hidden");
          } else {
            console.error("‚ùå No se encontraron datos para el nivel:", levelId);
            container.classList.add("hidden");
          }
        }

        // Inicializar
        document.addEventListener("DOMContentLoaded", function () {
          console.log("DOM Cargado");

          loadSitesData();

          const select = document.getElementById("levelSelect");
          if (select) {
            select.addEventListener("change", handleLevelChange);
            console.log("Event listener agregado");
          }

          // Validaci√≥n simple del formulario
          const form = document.querySelector("form");
          if (form) {
            form.addEventListener("submit", function (e) {
              const siteId = document.getElementById("siteId").value;
              const levelId = document.getElementById("levelSelect").value;

              // Si se seleccion√≥ un nivel pero no un sitio, bloquear env√≠o
              if (levelId && !siteId) {
                e.preventDefault();
                alert("Por favor, selecciona un sitio antes de continuar.");
                return false;
              }
            });
          }
        });

        // ELIMINAR: funci√≥n updateSubmitButton ya no es necesaria
        /*]]>*/
      </script>
    </div>
  </body>
</html>
